= 第 17 章 结论

事件驱动型微服务架构提供了强大、灵活且定义良好的方法来解决业务问题。本章是对本书所涵盖内容的快速回顾，另外还有一些最后的话。

[#_17_1_通信层]
== 17.1 通信层

数据沟通结构带来了跨整个组织的重要业务事件的通用访问。事件代理非常好地满足了这一需求，因为它们允许对数据进行严格的组织，可以近实时地传播更新，并且可以在大数据规模上运行。数据通信与负责转换和使用数据的业务逻辑保持严格的解耦，这些需求会转移到单独的界限上下文中。这种关注点的分离允许事件代理在很大程度上保持对业务逻辑需求的不可知性（除了支持读写之外），使它能够严格聚焦于存储、保存并交付事件数据给消费者。

成熟的数据通信层将数据的所有权和生产与数据的访问和消费分离开来。应用程序不再需要执行双重任务。（在服务内部业务逻辑的同时也为其他服务提供同步机制和外部的直接访问。）

任何服务都可以利用事件代理的持久性和弹性来使其数据高度可用，包括那些使用事件代理存储其内部状态变更日志的服务。服务实例故障不再意味着数据不可用，只是表明新数据会延迟到生产者重新上线。同时，在任何生产者中断期间，消费者都可以自由地消费事件代理的事件，从而与服务之间的故障模型解耦。

[#_17_2_业务领域和界限上下文]
== 17.2 业务领域和界限上下文

业务在特定的领域内执行操作，这个领域又可以分解为几个子领域。业务问题的解决方案是由界限上下文定义的，界限上下文标识了边界，这些边界包括与子域相关的输入、输出、事件、需求、流程和数据模型。

可以将微服务实现构建成与这些界限上下文保持一致。由此产生的服务和工作流可与问题和业务需求保持一致。通用数据通信层确保了微服务实现可以足够灵活以适应业务领域和随后的界限上下文的变化，从而有助于促进这些一致性。

[#_17_3_可共享的工具和基础设施]
== 17.3 可共享的工具和基础设施

事件驱动型微服务需要对允许其大规模运行的系统和工具进行投资，这种投资被称为微服务税。事件代理是系统的核心，因为它提供了服务之间的基本通信，并且免除了每个服务管理自己的数据通信解决方案的责任。

微服务架构放大了围绕创建、管理和部署应用程序的所有问题，并受益于这些过程的标准化和流水线化。随着微服务数量的增长，这一点变得更为关键，因为虽然每个新的微服务都会产生开销，但非标准化的微服务可能会比遵循协议的微服务产生更大的开销。

构成微服务税的基本服务如下。

* 事件代理
* schema 注册表和数据探测服务
* CMS
* 持续集成、交付和部署服务
* 监控和日志服务

支付微服务税不太可能是一个全有或全无的过程。组织通常会从事件代理服务或 CMS 开始，然后根据需要添加其他服务。幸运的是，一些计算服务提供商，比如谷歌、微软和亚马逊，已经创建了显著降低开销的服务。你必须权衡自己的方案，在将这些业务外包给服务提供商或在内部构建自己的系统之间做出选择。

[#_17_4_结构化事件]
== 17.4 结构化事件

schema 在传达事件的意义方面起着关键作用。强类型事件迫使生产者和消费者都要面对数据的真实情况。生产者必须确保根据 schema 来生产事件，而消费者必须确保会处理所消费事件的类型、范围和定义。强定义的 schema 大大减少了消费者误解事件的机会，并为将来的变更提供了契约。

schema 演化为事件和实体的变更提供了一种响应新业务需求的机制。它使生产者能够使用新的和修改过的字段生成数据，同时还允许不关心变更的消费者继续使用旧的 schema 进行消费。这极大地减少了非关键变更的频率和风险。同时，其余的消费者可以独立地升级代码，使用最新 schema 的格式来消费和处理事件，使它们能够访问最新的数据字段。

schema 还带来了一些有用的特性，比如代码生成和数据发现。代码生成器可以创建与生产和消费应用程序相关的类/结构体。这些强定义的类/结构体有助于在编译阶段或本地测试时检测生产和消费中的格式错误，以确保可以更好地生产和消费事件。这使得开发人员可以严格聚焦于处理和转换这些事件的业务逻辑而不是数据通道。同时，schema 注册表提供了一种可搜索的方法来确定哪些数据属于哪个事件流，从而更容易发现流的内容。

[#_17_5_数据解放和单一事实来源]
== 17.5 数据解放和单一事实来源

一旦有了可用的数据通信层，就可以让关键业务数据进入里面。从组织的各种服务和数据存储中解放数据是一个漫长的过程，将所有必要的数据放入事件代理需要一些时间。这是解耦系统并向事件驱动架构迈进的关键一步。数据解放将数据的生产和所有权与下游消费者对数据的访问进行了解耦。

应该先解放对组织达成下一个主要目标最常用及最关键的数据。从各种服务和数据存储中抽取信息的方法有很多，每种方法都有优点和缺点。权衡对现有服务的影响与过时数据、缺少 schema 以及解放事件流中的内部数据模型暴露的风险是很重要的。

image:image3.png[image,width=40,height=46]
以事件流的形式提供随时可用的业务数据使得可以通过组合方式构建服务。新服务只需要通过事件代理订阅感兴趣的事件流，而不是直接连接能提供数据的服务。

[#_17_6_微服务]
== 17.6 微服务

作为界限上下文的实现，微服务专注于解决界限上下文的业务问题，并进行相应的调整。业务需求变更是微服务更新的主要驱动力，所有其他不相关的微服务则保持不变。

避免基于技术边界来实现微服务。微服务通常是作为服务于多个业务工作流的短期优化而创建的，但是在此过程中，它们将自己与每个工作流都耦合了起来。技术型微服务对业务变更很敏感，并且将不相关的工作流耦合在了一起。技术型微服务中的故障或不经意的变更会导致多个业务工作流中断。尽可能避免技术上的一致性，而专注于满足业务的界限上下文。

此外，并非所有的微服务都必须很“微小”。一个组织使用几个较大的服务是合理的，特别是在它没有部分或全部支付微服务税的情况下。这是组织架构的正常演化过程。如果你的业务在使用大量大型服务，那么遵循以下原则将有助于创建与现有大型服务解耦的新的细粒度服务：

* 将重要的业务实体和事件放入事件代理中；
* 将事件代理作为单一事实来源使用；
* 避免服务间的直接调用。

[#_17_7_微服务实现方案]
== 17.7 微服务实现方案

对于构建事件驱动型微服务，有各种各样的方案可供选择，它们各有利弊。目前，轻量级框架往往具有最好的开箱即用功能。流可以物化到表并永久保存。可以对众多流和表执行联结操作，包括外键的联结。热副本、持久存储和变更日志提供了弹性和可伸缩性。

重量级框架提供了与轻量级框架类似的功能，但在处理独立性方面存在不足，因为它们需要单独的专用资源集群。新的集群管理方案正变得越来越流行，比如与 Kubernetes（领先的 CMS 之一）直接集成。重量级框架已经在中型和大型组织中使用，通常由执行大数据分析的人员操作。

BPC 模式和 FaaS 解决方案为许多编程语言和运行时提供了灵活的方案。这两种方案都受限于基础的消费和生产模式。确保确定性行为是很困难的，因为这两种方案都没有内置的事件调度，所以复杂的操作要么需要投入资源开发自定义库来实现该功能，要么将使用限制为简单的用例模式。

[#_17_8_测试]
== 17.8 测试

事件驱动型微服务非常适合于完全的集成测试和单元测试。作为事件驱动型微服务的主要输入形式，事件可以很容易地组合起来，以涵盖可能出现的任何情况。事件 schema 限制了需要测试的值的范围，并为组合输入测试流提供了必要的结构。

本地测试可以包含单元测试和集成测试，其中后者依赖于动态创建的事件代理、schema 注册表以及任何其他测试微服务所需要的依赖项。例如，可以创建一个事件代理，使其与测试的程序在同一个可执行文件中运行，就像许多基于 JVM 的解决方案一样，或者与被测试的应用程序一起在自己的容器中运行。通过对事件代理的完全控制，可以模拟负载、时间条件、中断、故障或任何其他代理与应用程序间的交互。

可以通过动态创建临时事件代理集群、使用生产环境事件流和事件的副本填充集群（排除信息安全问题）并针对集群执行应用程序来进行生产环境集成测试。这可以在生产环境部署之前提供冒烟测试，以确保没有忽略任何内容。还可以在此环境中执行性能测试，测试单个实例的性能和应用程序水平伸缩的能力。一旦测试完成，就可以简单地将环境丢弃。

[#_17_9_部署]
== 17.9 部署

大规模部署微服务要求微服务拥有者能够快速且简单地部署并回滚他们的服务。这种自主权允许团队独立行动，消除了原本只负责部署的基础设施团队中存在的瓶颈。持续集成管道、持续交付管道和持续部署管道对于提供此功能至关重要，因为它们允许流水线化定制的部署过程，从而减少手动干预步骤，并且可以扩展到其他微服务。你所选择的 CMS 可能会提供其他功能来帮助部署和回滚，从而进一步简化过程。

部署过程必须考虑 SLA、状态重建和输入事件流的再消费。SLA 不只是中断时间的问题，还需要考虑部署对所有下游消费者的影响，以及事件代理服务的健康情况。必须重建其整个状态并传播新的输出事件的微服务可能会给事件代理带来可观的负载，并导致下游消费者突然需要扩容到更多的处理实例。重建服务在短时间内处理数百万或数十亿个事件并不少见。限额可以减轻影响，但根据下游服务需求，重建服务处于不一致状态的时间可能是不可接受的。

在 SLA、对下游消费者的影响、对事件代理的影响以及对监控和告警框架的影响之间通常有一些折中。例如，蓝绿部署需要两个消费者组，必须考虑对它们的监控和警报，包括基于滞后度的自动伸缩。你可以针对此部署模式执行一些必要的适配性工作，而另一种方案是简单地更改应用程序的设计。蓝绿部署的一种替代方案是使用轻量且不中断的服务层来服务同步请求，而后端事件处理器可以暂时脱离对外服务并进行事件的重新处理。虽然服务层会在一段时间内提供过时的数据，但它不需要有更多工具支持或更复杂的交换操作，并且可能仍然满足依赖服务的 SLA。

[#_17_10_结语]
== 17.10 结语

事件驱动型微服务需要重新思考数据是什么以及服务要如何访问和使用数据。特定领域的数据量每年都在飞速增长，而且没有停止的迹象。数据正变得越来越大、越来越无处不在，而那些只需将数据塞进一个大型数据存储并用于各种目的的日子已经一去不复返了。一个健壮且定义良好的数据通信层减轻了服务执行双重任务的负担，并使得它们只专注于服务自己的业务功能，而不是服务于其他界限上下文的数据和查询需求。

事件驱动型微服务是处理这些大型和多样化数据集的计算的自然演变。事件流的组合特性使其具有无与伦比的灵活性，并使得各个业务部门能够专注于使用实现其业务目标所必需的数据。运行若干服务的组织可以从事件代理提供的数据通信中获益，这为构建新服务铺平了道路，与旧的业务需求和实现完全解耦。

不管事件驱动型微服务未来如何，有一点是显而易见的：数据通信层会将组织数据的能力扩展到任何需要它的服务或团队，消除访问边界，并降低与重要业务信息的生产和分发相关的不必要的复杂性。
